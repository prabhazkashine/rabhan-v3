// Payment Service Database Schema
// Migrated from projects-service

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum PaymentMethod {
  single_pay
  bnpl
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  refunded
  partially_paid
}

enum InstallmentStatus {
  upcoming
  due
  paid
  overdue
  failed
  cancelled
}

// ========================================
// PAYMENT MODELS
// ========================================

model ProjectPayment {
  id                    String              @id @default(uuid())
  project_id            String              @unique

  // Payment method and status
  payment_method        PaymentMethod
  payment_status        PaymentStatus       @default(pending)

  // Amounts
  total_amount          Decimal             @db.Decimal(12, 2)
  downpayment_amount    Decimal             @default(0) @db.Decimal(12, 2)
  remaining_amount      Decimal             @default(0) @db.Decimal(12, 2)
  paid_amount           Decimal             @default(0) @db.Decimal(12, 2)

  // BNPL specific fields
  number_of_installments Int?
  monthly_emi           Decimal?            @db.Decimal(12, 2)

  // Mock payment details
  payment_reference     String?             @unique
  payment_gateway       String?             @default("mock_gateway")

  // Admin to contractor payment tracking
  admin_paid_contractor Boolean             @default(false)
  admin_payment_amount  Decimal?            @db.Decimal(12, 2)
  admin_paid_at         DateTime?
  admin_payment_reference String?
  admin_payment_notes   String?             @db.Text

  // Contractor payment details
  contractor_bank_name  String?
  contractor_iban       String?
  contractor_account_holder String?

  // Timestamps
  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  completed_at          DateTime?

  // Relations
  installments          InstallmentSchedule[]
  transactions          ProjectPaymentTransaction[]

  @@index([payment_status])
  @@index([payment_method])
  @@index([project_id])
  @@map("project_payments")
}

model InstallmentSchedule {
  id                    String              @id @default(uuid())
  payment_id            String

  // Installment details
  installment_number    Int
  amount                Decimal             @db.Decimal(12, 2)
  due_date              DateTime
  status                InstallmentStatus   @default(upcoming)

  // Payment tracking
  paid_amount           Decimal             @default(0) @db.Decimal(12, 2)
  paid_at               DateTime?
  payment_reference     String?
  payment_method        String?             @default("mock_payment")

  // Late payment tracking
  is_overdue            Boolean             @default(false)
  overdue_days          Int                 @default(0)
  late_fee              Decimal             @default(0) @db.Decimal(10, 2)

  // Reminders
  reminder_sent         Boolean             @default(false)
  reminder_sent_at      DateTime?

  // Timestamps
  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt

  // Relations
  payment               ProjectPayment      @relation(fields: [payment_id], references: [id], onDelete: Cascade)

  @@index([payment_id])
  @@index([due_date])
  @@index([status])
  @@unique([payment_id, installment_number])
  @@map("installment_schedules")
}

model ProjectPaymentTransaction {
  id                    String              @id @default(uuid())
  payment_id            String

  // Transaction details
  transaction_type      String              // 'downpayment', 'full_payment', 'installment', 'admin_to_contractor'
  amount                Decimal             @db.Decimal(12, 2)
  status                String              // 'pending', 'success', 'failed'

  // Mock payment details
  transaction_reference String              @unique
  payment_method        String              @default("mock_payment")

  // Related installment (if applicable)
  installment_id        String?

  // Metadata
  metadata              Json?
  failure_reason        String?             @db.Text

  // Timestamps
  created_at            DateTime            @default(now())
  processed_at          DateTime?

  // Relations
  payment               ProjectPayment      @relation(fields: [payment_id], references: [id], onDelete: Cascade)

  @@index([payment_id])
  @@index([transaction_reference])
  @@index([created_at])
  @@map("project_payment_transactions")
}
